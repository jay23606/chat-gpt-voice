<!-- https://jay23606.github.io/chat-gpt-voice/html/peerjs-cam-fb7.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>PeerJS Video Chat</title>
  </head>
  <body>
    <div id="peers">
      <h3>My PeerJS ID: <span id="my-id"></span></h3>
      <button id="clear-all">Clear All Peers</button>
    </div>
    <div id="video-grid"></div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-database.js"></script>
    <script>
      // Initialize Firebase
      const firebaseConfig = {
        databaseURL: "https://jabdal-default-rtdb.firebaseio.com"
      };
      firebase.initializeApp(firebaseConfig);
      const dbRef = firebase.database().ref('peers');

      // Initialize PeerJS
      const peer = new Peer();
      const myIdSpan = document.getElementById('my-id');
      const clearAllButton = document.getElementById('clear-all');
      const videoGrid = document.getElementById('video-grid');
      let timeoutId = null;
      let callInProgress = false;
      let currentCall = null;

      function showAllPeers() {
        if (callInProgress) return;
        dbRef.once('value')
          .then((snapshot) => {
            const peersDiv = document.getElementById('peers');
            peersDiv.innerHTML = '';
            peersDiv.appendChild(document.createElement('hr'));
            peersDiv.appendChild(document.createElement('br'));

            // Add own PeerJS ID to the top of the list
            const myIdDiv = document.createElement('div');
            myIdDiv.innerText = `My ID: ${peer.id}`;
            peersDiv.appendChild(myIdDiv);
            peersDiv.appendChild(document.createElement('br'));

            // Check if already in a call
            let inCall = false;
            
            peer.on('call', (call) => {
              if (inCall) {
                call.answer();
                return;
              }

              inCall = true;
              currentCall = call;
              call.on('stream', (remoteStream) => {
                if (!callInProgress) {
                  callInProgress = true;
                  const video = document.createElement('video');
                  video.srcObject = remoteStream;
                  video.autoplay = true;
                  videoGrid.appendChild(video);
                }
              });

              const hangUpButton = document.createElement('button');
              hangUpButton.innerText = 'Hang Up';
              hangUpButton.onclick = () => {
                callInProgress = false;
                currentCall.close();
                currentCall = null;
                timeoutId = setTimeout(() => {showAllPeers();}, 5000);
              };
              peersDiv.appendChild(hangUpButton);
              if (callInProgress) {
                callInProgress = false;
              }
            });

            // Create Call and Answer buttons for each peer ID except own
            snapshot.forEach((childSnapshot) => {
              const key = childSnapshot.key;
              const value = childSnapshot.val();
              if (value !== peer.id) {
                const callButton = document.createElement('button');
                callButton.innerText = `Call ${value}`;
                callButton.onclick = () => {
                  const call = peer.call(value);
                  call.on('stream', (remoteStream) => {
                    if (!callInProgress) {
                      callInProgress = true;
                      const video = document.createElement('video');
                      video.srcObject = remoteStream;
                      video.autoplay = true;
                      videoGrid.appendChild(video);
                    }
                  });

                  const hangUpButton = document.createElement('button');
                  hangUpButton.innerText = 'Hang Up';
                  hangUpButton.onclick = () => {
                    callInProgress = false;
                    call.close();
                    timeoutId = setTimeout(() => {showAllPeers();}, 5000);
                  };
                  peersDiv.appendChild(hangUpButton);
                  if (callInProgress) {
                    callInProgress = false;
                  }
                };
                peersDiv.appendChild(callButton);
              }
            });
            timeoutId = setTimeout(() => {showAllPeers();}, 5000);
          })
          .catch((error) => console.error(error));
      }

      clearAllButton.onclick = () => {
        dbRef.remove();
        clearTimeout(timeoutId);
        callInProgress = false;
        currentCall?.close();
        currentCall = null;
        videoGrid.innerHTML = '';
        showAllPeers();
      };
    </script>
  </body>
</html>
