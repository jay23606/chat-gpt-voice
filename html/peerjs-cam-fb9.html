<!-- https://jay23606.github.io/chat-gpt-voice/html/peerjs-cam-fb9.html -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PeerJS Video Chat</title>
</head>
<body>
  <div id="peers">
    <h3>My PeerJS ID: <span id="my-id"></span></h3>
  </div>
  <div id="video-grid"></div>
  <button id="hang-up-btn" style="display: none;">Hang Up</button>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-database.js"></script>
  <script>
    const firebaseConfig = { databaseURL: "https://jabdal-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref('peers'),
          $ = (id) => document.getElementById(id),
          $$ = (sel) => document.querySelectorAll(sel),
          peer = new Peer();
    const myIdSpan = $('my-id'),
          videoGrid = $('video-grid'),
          callTimeout = 60000;
    let currentCalls = new Map(),
        refreshTimeoutId = null;
    peer.on('open', (id) => {
      myIdSpan.innerText = id;
      dbRef.onDisconnect().remove();
      dbRef.push(id);
      refreshPeers();
    });
    peer.on('close', () => {
      dbRef.once('value').then((snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const key = childSnapshot.key;
          const value = childSnapshot.val();
          if (value === peer.id) dbRef.child(key).remove();
        });
      }).catch((error) => console.error(error));
    });
    peer.on('call', (incomingCall) => {
      if ($$('video').length > 0) {
        incomingCall.close();
        return;
      }
      clearTimeout(refreshTimeoutId);
      navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then((stream) => {
        currentCalls.set(incomingCall.peer, incomingCall);
        incomingCall.answer(stream);
        incomingCall.startTime = Date.now();
        incomingCall.on('stream', (remoteStream) => {
          const video = document.createElement('video');
          video.srcObject = remoteStream;
          video.autoplay = true;
          videoGrid.appendChild(video);
          $('hang-up-btn').style.display = 'block';
        });
        incomingCall.on('close', () => {
          currentCalls.delete(incomingCall.peer);
          videoGrid.removeChild(videoGrid.querySelector(`[data-peer="${incomingCall.peer}"]`));
          if (currentCalls.size === 0) {
            refreshPeers();
            $('hang-up-btn').style.display = 'none';
          }
        });
      }).catch((error) => console.error(error));
    });
    const refreshPeers = () => {
      if ($$('video').length > 0) return;
      dbRef.once('value').then((snapshot) => {
        const peersDiv = $('peers');
        peersDiv.innerHTML = '';
        peersDiv.appendChild(document.createElement('hr'));
        peersDiv.appendChild(document.createElement('br'));
        const myIdDiv = document.createElement('div');
        myIdDiv.innerText = `My ID: ${peer.id}`;
        peersDiv.appendChild(myIdDiv);
        peersDiv.appendChild(document.createElement('br'));
        if (currentCalls.size > 0) {
          currentCalls.forEach((call) => {
            if (Date.now() - call.startTime >= callTimeout) {
              call.close();
            } else {
              const video = document.createElement('video');
              video.srcObject = call.remoteStream;
              video.autoplay = true;
              video.dataset.peer = call.peer;
              videoGrid.appendChild(video);
            }
          });
        }
        snapshot.forEach((childSnapshot) => {
          const value = childSnapshot.val();
          if (value === peer.id || currentCalls.has(value)) return;
          const callButton = document.createElement('button');
          callButton.innerText = `Call ${value}`;
          callButton.addEventListener('click', () => {
            if ($$('video').length > 0) {
              alert('You are already in a call');
              return;
            }
            clearTimeout(refreshTimeoutId);
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then((stream) => {
              const call = peer.call(value, stream);
              currentCalls.set(value, call);
              call.startTime = Date.now();
              call.on('stream', (remoteStream) => {
                const video = document.createElement('video');
                video.srcObject = remoteStream;
                video.autoplay = true;
                video.dataset.peer = value;
                videoGrid.appendChild(video);
                $('hang-up-btn').style.display = 'block';
              });
              call.on('close', () => {
                currentCalls.delete(value);
                videoGrid.removeChild(videoGrid.querySelector(`[data-peer="${value}"]`));
                if (currentCalls.size === 0) {
                  refreshPeers();
                  $('hang-up-btn').style.display = 'none';
                }
              });
            }).catch((error) => console.error(error));
          });
          peersDiv.appendChild(callButton);
          peersDiv.appendChild(document.createElement('br'));
        });
        if (refreshTimeoutId === null) {
          refreshTimeoutId = setTimeout(() => {
            refreshPeers();
          }, 5000);
        }
      }).catch((error) => console.error(error));
    };
    const hangUp = () => {
      currentCalls.forEach((call) => call.close());
      currentCalls.clear();
      // Remove all video elements
      $$('video').forEach((video) => video.remove());
      refreshPeers();
      $('hang-up-btn').style.display = 'none';
    };
    $('hang-up-btn').addEventListener('click', hangUp);
  </script>
</body>
</html>
