<!-- https://jay23606.github.io/chat-gpt-voice/html/peerjs-cam-fb12.html -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PeerJS Video Chat</title>
</head>
<body>
  <div id="peers">
    <h3>My PeerJS ID: <span id="my-id"></span></h3>
    <button id="refresh-btn">Refresh</button>
  </div>
  <div id="video-grid"></div>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-database.js"></script>
  <script>
    const firebaseConfig = { databaseURL: "https://jabdal-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref('peers'),
          $ = (id) => document.getElementById(id),
          peer = new Peer();
    const myIdSpan = $('my-id'),
          videoGrid = $('video-grid');
    let currentCalls = new Map(),
        videoElements = new Map();

    const endCall = (video) => {
      const peerId = video.dataset.peer;
      currentCalls.get(peerId).close();
      currentCalls.delete(peerId);
      const videosToRemove = document.querySelectorAll(`video[data-peer="${peerId}"]`);
      videosToRemove.forEach((video) => {
        video.parentNode.removeChild(video);
      });
      console.log(`Call with ${peerId} closed`);
      refreshPeers();
    }

    peer.on('open', (id) => {
      myIdSpan.innerText = id;
      dbRef.onDisconnect().remove();
      dbRef.push(id);
      refreshPeers();
    });
    peer.on('call', (incomingCall) => {
      const answerCall = (stream) => {
        currentCalls.set(incomingCall.peer, incomingCall);
        incomingCall.answer(stream);
        incomingCall.startTime = Date.now();
        incomingCall.on('stream', (remoteStream) => {
          if (!videoElements.has(incomingCall.peer)) {
            const remoteVideo = document.createElement('video');
            remoteVideo.srcObject = remoteStream;
            remoteVideo.autoplay = true;
            remoteVideo.dataset.peer = incomingCall.peer;
            videoGrid.appendChild(remoteVideo);
            remoteVideo.addEventListener('click', () => {
              endCall(remoteVideo);
            });
            videoElements.set(incomingCall.peer, remoteVideo);
          } else {
            const remoteVideo = videoElements.get(incomingCall.peer);
            remoteVideo.srcObject = remoteStream;
          }
        });
        if (!videoElements.has('me')) {
          const localVideo = document.createElement('video');
          localVideo.srcObject = stream;
          localVideo.autoplay = true;
          localVideo.muted = true;
          localVideo.dataset.peer = 'me';
          videoGrid.appendChild(localVideo);
          videoElements.set('me', localVideo);
        } else {
          const localVideo = videoElements.get('me');
          localVideo.srcObject = stream;
        }
      };
      navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(answerCall).catch((error) => console.error(error));
    });
    const refreshPeers = () => {
      dbRef.once('value').then((snapshot) => {
        const peersDiv = $('peers');
        peersDiv.innerHTML = '';
        peersDiv.appendChild(document.createElement('hr'));
        peersDiv.appendChild(document.createElement('br'));
        const myIdDiv = document.createElement('div');
        myIdDiv.innerText = `My ID: ${peer.id}`;
        peersDiv.appendChild(myIdDiv);
        peersDiv.appendChild(document.createElement('br'));
        const refreshBtn = document.createElement('button');
        refreshBtn.innerText = 'Refresh';
        refreshBtn.addEventListener('click', refreshPeers);
        peersDiv.appendChild(refreshBtn);
        peersDiv.appendChild(document.createElement('br'));
        snapshot.forEach((childSnapshot) => {
          const value = childSnapshot.val();
          if (value === peer.id) return;
          const callButton = document.createElement('button');
          callButton.innerText = `Call ${value}`;
          callButton.addEventListener('click', () => {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then((stream) => {
              if (!videoElements.has('me')) {
                const localVideo = document.createElement('video');
                localVideo.srcObject = stream;
                localVideo.autoplay = true;
                localVideo.muted = true;
                localVideo.dataset.peer = 'me';
                videoGrid.appendChild(localVideo);
                videoElements.set('me', localVideo);
              } else {
                const localVideo = videoElements.get('me');
                localVideo.srcObject = stream;
              }
              const call = peer.call(value, stream);
              currentCalls.set(value, call);
              call.startTime = Date.now();
              call.on('stream', (remoteStream) => {
                if (!videoElements.has(value)) {
                  const remoteVideo = document.createElement('video');
                  remoteVideo.srcObject = remoteStream;
                  remoteVideo.autoplay = true;
                  remoteVideo.dataset.peer = value;
                  videoGrid.appendChild(remoteVideo);
                  remoteVideo.addEventListener('click', () => {
                    endCall(remoteVideo);
                  });
                  videoElements.set(value, remoteVideo);
                } else {
                  const remoteVideo = videoElements.get(value);
                  remoteVideo.srcObject = remoteStream;
                }
              });
            }).catch((error) => console.error(error));
          });
          peersDiv.appendChild(callButton);
          peersDiv.appendChild(document.createElement('br'));
        });
      }).catch((error) => console.error(error));
    };
  </script>
</body>
</html>
